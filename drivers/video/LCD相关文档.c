//LCD控制器驱动的24位TFT真彩屏接口设计 
//
//  在嵌入式设计中常常会使用LCD屏，现在常用的屏大部分都是高性能的。因为LCD屏的生产厂商很多，标准也不统一，LCD屏往往不能与LCD控制器无粘合连接，所以在使用LCD屏时，厂家还会推荐使用其专为LCD屏是设计的时序芯片，例如，Sharp的LCD LQ035Q7DB02配套的控制器为LZ9FC22；日本的LCD屏是16位色的，本身价格很高，控制器成本也非常高，性能却不见得好，采用高性能的24位真彩色屏是比较理想的，但接口逻辑需要重新设计。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  1 RGB565－RGB888的转换                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  以友达光电AUO生产的A06QU01[1]为例，这是一种24位的TFT真彩屏，分辨率为320×240，每个象素由RGB888表示，其控制时序如图1所示，LCD要求的时序由帧同步（VSYNC）、行同步（HSYSNC）、比特时钟（DCLK）及数据（Data[0：7]）构成，帧同步和行同步指示每一帧和每一行的开始。A06QU01每帧240行，每行320个象素，每个像素由依次产生的8b红、8b绿、8b蓝（R1，G2，B3，R4，G5，B6…）构成，所以称为RGB888。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
//  ;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  以PXA25x为代表的嵌入式处理器拥有一个LCD控制器，可以将这个控制器配置为最高16位的TFT LCD屏控制器，其控制时序如图1所示，LCD要求的时序由帧同步（VSYNC）、行同步（HSYSNC）、点时钟（PCLK）及数据（Data[0：15]构成，帧同步和行同步指示每一帧和每一行的开始。对于A06QU01，每帧将有240行，每行有320个像素，每个像素由5b红、6b绿、5b蓝构成16位数据，称为RGB565。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  将RGB565转换为RGB888要解决2个问题：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  1）比特时钟3倍频。LCD控制器每一个像素用一个时钟1次送出16b数据，而LCD撩扛鱿袼匦枰?个时钟，每次获得8b。这样就需要产生1个3倍于点时钟PCLK的时钟。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  2）16b到24b数据分解。在LCD控制器送出16b数据时，需要缓存，并分解出RGB信号分别送出，5b红、6b绿、5b蓝构成16位数据可以采用补0的方法，构成8b红、8b绿、8b蓝。数据高位补0时色彩较柔和，低位补0时彩色较艳丽。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  通常情况下，使用模拟锁相环技术可以实现均匀倍频，在这个设计中，3倍频时钟与RGB数据必须同步，否则会出现颜色错位；同时锁相环还需要数据分解电路配合使用，这样一个数字和模拟混合的电路会增加成本，因而特别设计使用了数字电路实现非均匀3倍频。具体方案是：使用一个大于6小于7倍的LCD屏比特时钟作为CPLD的主控制时钟，LCD屏的时钟频率约为7M赫兹，所以选择CPLD的主控制时钟频率为48M赫兹。如图1所示，pclk为控制器输出的点时钟，pdata为RBG565数据，pclkout和pdataout是送往LCD的信号，x7pclk为CPLD的定时时钟，在pclk上升沿将pdata存入缓冲器pdatabuf，并将内部状态位datavalid置位，在x7pclk的上升沿，如果检测到datavalid为高，则使pclkout为低，将缓冲器中的数据取出高5位红色信号，补零后送到pdataout，并将datavalid置为低，在下一个x7pclk的上升沿将pclkout置高，8b数据送出到LCD屏。使用这种方法依次将绿色及蓝色信号送出，在蓝色信号送出后，保持pclkout为高，直到下一个datavalid为高，进入下一次转换，从图1中可以看出，数字3倍频信号pclkout不是均匀的，蓝色数据时钟的占空比不是50％。根据LCD屏数据手册的要求，pclkout的占空比变化容许的范围是40％－60％，因而只要调整好x7pclk的时钟频率，还是比较容易产生符合占空比要求的pclkout时钟的，LCD屏正常工作还需要帧同步（VSYNC）和行同步（HSYSNC）信号，这些信号可以由软件驱动程序编程产生。
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  LCD背光及LCD偏置的电源产生器                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  LCD屏需要特殊的供电，用于背景照明和LCD偏置，现在使用的小尺寸LCD大多数使用LED作为背光，以及－10V的偏置电压，本设计使用的LCD屏是2路各4个白光LED串联，每路需要的供电电压约为10V，电流为20mA。LCD偏置电压为－10V，电流为3－5mA。这些电源利用LCD控制器内部的电源控制器实现。如图2所示，由L1、V1构成升压型DC－DC转换器，L1为高频功率电感，V1为高频小功率开关晶体管。C4和R1构成的微分电路可以提高V1的导通和关闭速度，有利于提高电源效率，V1由脉冲宽度调制信号控制，在导通期间使用L1存储能量，在关闭时电感向负载释放能量，这样V1的集电极上生成高压脉冲信号，这个信号经过D1、C3和C6整流滤波后得到用于LED供电正电压，同样经过C2隔直流后再整流滤波得到用于LCD偏置的负电压，注意，电容C7是正端接地的。LED电流限制使用图3所示的电路，V3和V4为LED驱动管，V2为电流采样管，V2、V3、V4是3个型号相同的晶体管。这3个晶体管的基级相连，因而基极电压相等。因为型号相同，所以基极到发射极电压近似相等，于是，R3、R6、R7上的压降近似相等，这样R3、R4上的电流被转换为R2上的反馈电压。控制器根据反馈电压自动调整图2中的PWM控制信号的占空比，从而改变输出LED供电电压，使反馈电压稳定在0.6V，通过LED的电流稳定在22mA，LCD偏置电压大约稳定在－10V。                                                                                               
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  3 数字倍频及数据分解实现                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  RGB565－RGB888转换器用XC9536实现，如图4所示，来自LCD控制器的信号为：16b数据L_DD0..15、同步信号L_FCLK及L_LCLK、点时钟信号L_PCLK，输出到LCD屏的信号为：8b数据信号LCD_D0..7、同步信号LCD_VSYNC及LCD_HSYNC、时钟信号LCD_DCLK。X7CLK来自于48M赫兹的晶体振荡器，使用Verilog HDL开发。如果连接无误，则上电后加载带有TFT屏驱动的嵌入式Linux内核，一般在LCD屏左上角能看到企鹅图案，如果实际显示的图案位置和色彩不正确，则需要根据实际看到的图像调整LCD控制寄存器中的时序设置，实现正确的显示。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  4 总结                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//  由于接口标准不统一、将一个新型号的LCD屏接到嵌入式处理器比较困难，需要认真分析LCD控制器及LCD屏的时序和驱动方式，使用低价可编程逻辑电路，可以实现接口的时序转换，LCD屏需要的背光电源及偏置电源可以按本文所述方法，利用LCD屏内部集成的电源控制器实现，也可以通过外接专用的LCD背光电源和LCD偏置实现。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
//  
// ========================================================================================================= 
//RGB接口的TFT LCD模组的电路及驱动开发         
//
//我们先来看看驱动电路部分。记得在很早的时候，那时候还都是FSTN的显示屏满天飞的时候。LCD的驱动电路有很多是两片芯片的，一片LCDC，一片LCDDriver，一般的LCDC里面有一个display的buffer。LCDDriver是电路驱动液晶显示部分的电路，没有什么好讲的。更早的时候，LCD上就一片LCDDriver就行了，程序员需要控制两个（H,V)场扫描信号，而且程序员希望在某个坐标显示，都需要编程控制驱动电路来实现，后来发现显示屏越来越大，而MCU以及程序员没有这个能力和精力来对LCD进行这类的同步控制，于是LCDC就诞生出来承担起这些个功能。后来加上了buffer，就是说程序员可以把大批的显示内容以显示矩阵（display matrix）的形式写到buffer里，让LCDC来读取buffer里的数据再由LCDDriver显示到显示屏上。后来这个buffer越来越大，除了显示矩阵以外还放很多命令，所以也不能老把它笼统的叫buffer啊，所以就对放显示矩阵的存储空间有了一个专用的名字叫做GRAM。到现在嘛，这些驱动/控制电路以及buffer都合起来放在一片芯片中，统称为driver IC啦。也就是LCM上那颗COG的芯片，相信看这片回帖的兄弟们都看到过。而且这颗driver IC的功能越来越nb，有什么dimm功能啊，gamma功能啊，什么省电啊等等乱七八糟的功能，不过大多功能程序员都不需要去详细了解，现在的程序员都很轻松啦，只需要用很简单的几条命令就可以控制这颗driver IC来驱动LCD。
//上面说的LCD的驱动电路的发展，而接口都是一直是CPU接口。因为这个发展的方向是：LCD driver作为MCU的一片协处理芯片，接受MCU发过来的command/data，而可以相对独立的处理显示工作。而怎么处理显示工作的过程，对于MCU和程序员来说，都是透明的。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
//后来为什么出现了RGB的接口电路，小弟真的还不知道为什么。但是有两点很清楚：一是用RGB接口的MCU/Backend IC一般都更加的强大，有专门的接口电路来配合RGB显示。一是一般用RGB接口的LCD driver都没有GRAM，这大大的降低了LCD driver的成本，而将这些成本转移到更大的液晶显示区域去。所以不难看出，高端的显示屏（>=2.2"，QCIFF）的一般都会选用RGB接口。想想吧，26w色的QCIFF的显示屏至少需要多少GRAM啊，这都是钱啊！                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
//其实RGB接口的LCD也很简单了，甚至比CPU接口的LCD还要简单。和CPU接口的LCD driver相比，RGB接口的driver去掉了一个接口电路，就是去掉了CPU接口中的一个处理COMMAND/DATA数据的IO电路。（这个我光用语言说不大清楚，等小弟有空做一个ppt再放上来）这样的话，就需要MCU提供两个场同步信号（H,V），无疑提高了对MCU的要求，而且，LCD的帧率唯一受MCU/Backend IC的接口速度限制，所以如果MCU足够nb的话，LCD的刷新速度还是很不错的。还有就是有的GRB接口的driver做得还不是很nb，需要用SPI来传输一些少量的命令，而很多MCU没有这么一个专用的SPI，所以要用GPIO来模拟SPI。呵呵，看看也是够麻烦的。而且最郁闷的是，因为考虑到很多MCU/Backend IC芯片的接口速度还不是足够的快，所以很多厂家在LCD driver里还是放了部分或者是整个显示内存――唉，还是没有达到省钱的目的啊！                                                                                                                                                                                                                                                                                                                                                                                                                                
//
// =========================================================================================================          
//LCD的CPU接口和RGB接口(MPU接口的)   
//  
//目前一般彩色LCD的连接方式有这么几种：MCU模式，RGB模式，SPI模式，VSYNC模式，MDDI模式等。    
//                                                                                             
//MCU模式：目前最常用的连接模式，一般是80系统（68系统已经不存在了）。数据位传输有8位，9位，    
//                                                                                             
//         16位和18位。连线分为：CS/，RS(寄存器选择），RD/，WR/，再就是数据线了。优点是：控    
//                                                                                             
//         制简单方便，无需时钟和同步信号。缺点是：要耗费GRAM，所以难以做到大屏（QVGA以上）.   
//                                                                                             
//RGB模式：大屏采用较多的模式，数据位传输也有6位，16位和18位之分。连线一般有：VSYNC，HSYNC     
//                                                                                             
//         ，DOTCLK，VLD，ENABLE，剩下就是数据线。它的优缺点正好和MCU模式相反。                
//                                                                                             
//SPI模式：采用较少，连线为CS/，SLK，SDI，SDO四根线，连线少但是软件控制比较复杂。              
//                                                                                             
//VSYNC模式：该模式是在MCU模式下增加了一根VSYNC（帧同步）信号线而已，应用于运动画面更新。      
//                                                                                             
//MDDI模式：高通公司于2004年提出的接口MDDI（Mobile Display Digital Interface），通过减少连     
//                                                                                             
//           线可提高移动电话的可靠性并降低功耗，这将取代SPI模式而成为移动领域的高速串行接口   
//                                                                                             
//           。连线主要是host_data,host_strobe,client_data,client_strobe,power,GND几根线。目   
//                                                                                             
//           前瑞萨和三星才刚刚出货（主要是大屏的）。                                          
//                                                                                             
//通过观察LCM模组提供商提供的封装接口图，就大致可以看出它提供的是什么接口，主要是根据用户的    
//                                                                                             
//要求来选择。                                                                                 
//                                                                                             
//
//                                                                                                                                                                                        
//LCD的接口有多种，分类很细。 主要看LCD的驱动方式和控制方式。                                  
//                                                                                             
//大致可以分为 MCU接口和RGB接口。                                                              
//                                                                                             
//对于MCU接口主要又可以分为8080模式和6800模式，这个主要是时序的区别。                          
//                                                                                             
//对于RGB接口则可以分为模拟RGB， ADC接口和数字RGB接口。                                        
//                                                                                             
//            至于需要不需要HSNC，VSNC信号，这个是在RGB接口中，但也要看采用什么样制式的控制    
//                                                                                             
//            驱动模式，也可以不需要的。                                                       
//                                                                                             
//MCU接口: 会解码命令，由 timing generator 产生时序信号，驱动 COM 和SEG驱动器。                
//                                                                                             
//RGB接口: 在写LCD register setting时，和MPU没有区别。区别只在于图像的写入方式。               
//                                                                                             
//MCU模式需要的信号有WR，RD，RS，RESET，CS。                                                   
//                                                                                             
//RGB模式需要的信号有HSYNC，VSYNC，ENABLE，CS，RESET，有的也需要RS。                           
//                                                                                             
//用MCU模式时由于数据可以先存到IC内部GRAM后再往屏上写，所以这种模式LCD可以直接接在MEMORY的     
//                                                                                             
//            总线上。                                                                         
//                                                                                             
//用RGB模式时就不同了，它没有内部RAM，HSYNC，VSYNC，ENABLE，CS，RESET，RS可以直接接在MEMORY    
//                                                                                             
//            的GPIO口上，用GPIO口来模拟波形，但有没有这么多空闲的GPIO口是个要考虑的问题，另   
//                                                                                             
//            外由于它不带RAM所以数据是直接往                                                  
//
//                                                                                             
//最主要的区别是：                                                                             
//                                                                                             
//MPU接口方式：显示数据写入DDRAM，常用于静止图片显示。                                         
//                                                                                             
//RGB接口方式：显示数据不写入DDRAM，直接写屏，速度快，常用于显示视频或动画用。                 
//                                                                                             
//只有TFT模块才有RGB接口。    
//
//=========================================================================================    
//                                                                                               
//LCD基本知识、操作过程时序讲解 
//
//真彩色是指在组成一幅彩色图像的每个像素值中，有R，G，B三个基色分量，每个基色分量直接决定显示设备的基色强度，这样产生的彩色称为真彩色。例如用RGB 5∶5∶5表示的彩色图像，R，G，B各用5位，用R，G，B分量大小的值直接确定三个基色的强度，这样得到的彩色是真实的原图彩色。
//
//         256色（8BPP）的显示模式就是使用8位的数据来表示一个像素的颜色，但是对三种原色平均下来，每个原色只能使用不到3位的数据来表示，即每个原色最多不过8级别，这不足以表示更丰富的颜色。
//           为了解决8BPP模式的显示能力太弱的问题，需要使用调色板（Palette）。每个像素对应的8位数据不再用来表示RGB三种原色，而是表示他在调色板中的索引值：要显示这个像素时，使用这个索引值从调色板中取得RGB颜色值。所谓调色板就是一块内存，可以对每个索引值设置其颜色，可以使用24BPP或16BPP。在S3C2440中，调色板是一块256X16的内存，使用16BPP的格式来表示256色（8BPP）显示模式下各个索引值的颜色。这样，即使使用256色（8BPP）的显示模式，最终出现在LCD数据总线上的仍是16BPP的数据。
//
//
//             要想理解LCD初始化函数，及一些函数。必须得理解LCD显示原理，LCD控制器的控制信号。2440使用的是TFT_LCD，所以我只看TFT的操作，各信号的含义。
//
//              LCD控制器利用DMA从SDRAM中（帧缓冲），取像素数据。然后通过VD[23：0]赋值给像素。
//              LCD显示过程，是逐行扫描每个像素点，利用VD[23:0]控制每个像素点，从而显示图像。
//                而LCD的控制信号，在LCD控制器里面配置。这样使LCD控制器，适应不同的屏幕。
//
//            VCLK信号：是像素的时钟信号。VCLK(Hz) = HCLK/[(CLKVAL+1)x2]。每一个VCLK信号表示正在传输一个像素的数据，无论它是否有效。
//             VSYNC信号：垂直同步信号。说帧同步信号，更好理解。当此信号到达时，告诉LCD新的一帧数据送过来了。一帧就是当把LCD屏的像素都点亮了（320X240）。表示一帧数据的开始。
//             HSYNC信号：水平同步信号，行同步信号。当此信号到达时，告诉LCD下一行的数据来了。（共240行）
//              VD[23：0]信号：将一个像素点的数据，送到LCD的像素点。表示一行数据的传输，所以此LCD最大是24BPP。
//
//
//datasheet P418 LCD 时序图讲解
//
//1、VSYNC信号有效时，表示一帧数据的开始。
//2、VSPW信号：表示VSYNC信号的脉冲宽度为（VSPW+1）个HSYNC信号周期，即（VSPW+1）行。这（VSPW+1）行的数据无效。
//3、VSYNC信号脉冲之后，还要经过（VBPD+1）个HSYNC信号周期，有效的行数据才出现，所以，在VSYNC信号有效后，总共还要经过（VSPW+1+VBPD+1）个无效的行，第一个有效的行才出现。
//4、随后立即发出（LINEVAL+1）行的有效数据。
//5、最后是（VFPD+1）个无效的行，完整的一帧结束，紧接着就是下一帧的数据（即下一个VSYNC信号）。
//
//现在深入到一行中像素数据的传输过程
//
//1、HSYNC信号有效时，表示一行数据的开始。
//2、HSPW表示HSYNC信号的脉冲宽度为（HSPW+1）个VCLK信号周期，即（HSPW+1）个像素，这（HSPW+1）个像素的数据无效。
//3、HSYNC信号脉冲之后，还要经过（HBPD+1）个VCLK信号周期，有效的像素数据才出现。所以，HSYNC信号有效后，总共还要经过（HSPW+1+HBPD+1）个无效的像素，第一个有效地像素才出现。
//4、随后即连续发出（HOZVAL+1）个像素的有效数据。
//5、最后是（HFPD+1）个无效的像素，完整的一行结束，紧接着就是下一行的数据（即下一个HSYNC信号）。
//
//        LCD控制器中REGBANK的17个寄存器
//1、LCDCON1~LCDCON5   用于选择LCD类型，设置各类控制信号的时间特性等
//2、LCDSADDR1~LCDSADDR3 用于设置帧内存的地址
//3、TPAL    临时调色板寄存器，可以快速地输出一帧单色的图像
//4、LCDINTPND
//     LCDSRCPND       用于LCD的中断，在一般应用中无需中断
//      LCDINTMSK
//5、REDLUT
//      GREENLUT
//    BLUELUT                专用于STN LCD
//     DITHMODE
//6、TCONSEL   专用于SEC TFT LCD
//
//
//
//
//
//
//
//
//
//                                                                
//=========================================================================================  
//LCD 原理和移植总结   
//
//Framebuffer：是linux的framebuffer驱动在内存开辟的一块显存，存放一帧图像数据。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//IPU：是mx51的图像处理单元，里面包含DMA控制器和DI显示接口等。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                =========================================================================================    
//LCDDriver：是一块和LCD屏幕整合在一起的驱动芯片，接收IPU传过来的数据和时序信号，转化为有规律的LCD驱动电压。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            =========================================================================================      
//一幅图像的显示过程是这样的：用户打开/dev/fbx设备，使用mmap()系统调用映射framebuffer内存空间到用户空间，用户直接用 memcpy()复制图像数据到framebuffer，DMA探测到framebuffer数据发生变动，启动DMA传输图像数据到IPUI，PU再根据framebuffer驱动设置的处理模式对像素数据进行一系列处理，比如framebuffer使用了overlay framebuffer那就启动overlay处理单元混合两个framebuffer的数据，另外IPU还会packing像素数据，比如 framebuffer里像素格式为RGB565，IPU会把他packing成RGB666的格式，以配合LCD模块的接口。IPU处理完数据后，送到 DI，在DI时序模块产生的时序信号同步下，一起输出到LCD驱动芯片。                                                         
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//移植LCD驱动的第一步，是确保IPU输出给LCD Driver的时序、数据、供电信号是对的。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//时序信号一般是根据LCD的datasheet上的参数，填写fb_videomode这个结构体：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
struct fb_videomode {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        const char *name;        /* optional */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
        u32 refresh;                /* optional */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
        u32 xres;                // x分辨率                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        u32 yres;                // y分辨率                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
        u32 pixclock;                // 像素时钟频率，即每个时钟周期显示一个像素点                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
        u32 left_margin;        // 行扫描开始脉冲到一行像素数据开始输出的延迟 hsync<==>DEN                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
        u32 right_margin;        // 一行像素数据输出完毕到下一行的行扫描开始脉冲间的延迟 DEN <==>hsync                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
        u32 upper_margin;        // 帧扫描开始脉冲到第一行像素数据开始输出的延迟 vsync<==>DEN(1st line)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
        u32 lower_margin;        // 最后一行像素数据输出结束到下一帧的那帧扫描开始脉冲间的延迟DEN(last line)<==>vsync                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
        u32 hsync_len; // 行扫描脉冲宽度，单位为pixclock                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
        u32 vsync_len; // 帧扫描脉冲宽度，单位为line                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
        u32 sync; // 各同步信号的极性定义，如hsync、vsync、DEN的极性等。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
        u32 vmode; // 显示模式，逐行还是隔行扫描                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
        u32 flag; // 一般为0                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//这个结构体定义完之后，对于一般的LCD，在连线正确的情况下，系统启动后应该就出来图像了，此时图像可能是上下跳动或者左右有偏移，这就需要再调整一下 fb_videomode中left/right/upper/lower margin参数。如果上电后没有图像，则首先用示波器检测hsync, vsync,DEN,pclk等波形是否正确，使用双踪示波器通过hsync、vsync与DEN的比对查看left/right/upper /lower margin是否合适。如果这些信号都没有问题，那么说明LCD需要通过spi总线发送命令对其进行初始化。初始化代码一般由LCD厂商提供，不过很多厂商提供的初始化代码都有问题，会导致LCD白屏或者其他不正常的现象。                                                                                             
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//TFT LCD的原理：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//图2. TFT LCD截面图                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//TFT LCD主要由两个透明电极，中间的液晶分子和一个有色玻璃组成。在没有通电的情况下，液晶分子呈无规则排列，背光无法透过液晶层。当有外加电场时，液晶分子顺着电场的方向有序排列，背光可以通过，并且由于有色玻璃的滤光，呈现红，绿，蓝色调，不过，背光的透过率只有10%，这是LCD的一个缺点。                                                                                                                                                                                                                                                                                                                                                         
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//以上是一个像素中的一个RGB分量的产生过程。接下来看看如何整合这个基本单元，组成一个LCD屏幕。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//图3. LCD平面图                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//这个图比上面多出来的是2种长条和一种MOS晶体管。这3个东西的作用是在一定的时序下给各显示电极充电。横向的长条和LCD驱动芯片的Gate Driver连接的，用于打开各行的MOSFET。纵向的长条和LCD驱动芯片的Source Driver连接，代表RGB数据。整个过程大致是这样的：首先第一行的Gate线产生一个充电脉冲，使第一行的MOS管导通，同时Source线那边经过数模转换后的RGB电压也已经就绪，于是通过MOS管对显示电极充电，每个pixel clock充电一个像素，即3根Source线完成充电。对于320x480的屏，一共有480根Gate线，320x3=960根Source线，则经过320个pclk后，第一行充电完成，显示出相应的画面。然后，第二行的Gate线产生一个充电脉冲，一次类推，直到最后一行，又从第一行开始.....
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
//LCD点屏步骤：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//1.参考LCD datasheet修改fb_videomode结构体的参数。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
//2.配置GPIO，点亮LCD背光。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
//3.参考LCD datasheet看这个LCD是否需要spi总线发送命令进行初始化，一般厂商给datasheet时也会给一份初始化代码，不过有些参数是错误的，需要调整，发送不正确的命令会导致LCD白屏。                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
//4.用示波器测试从LCD控制器出来的Hsync, Vsync, DE, PCLK是否正确，用万用表测量Vio, Vci是否正常。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//5.有的LCD Driver需要LCD控制器发出一个CS片选使能信号。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
//6.用万用表测量LCD的栅压是否正常，一般为9.2V。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//7.如果上述步骤后还出不来，再检查LCD初始化命令是否正确，spi时序是否符合。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//图像异常处理：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//1.驱动问题                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
//上下抖动，左右没对齐：调整left/right/upper/lower margin值                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
//2.LCD初始化命令问题                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
//有纹波：调整VDD/AVDD/VGL/VGH电压                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//色彩失真：看LCD的RGB模式设置和LCD控制器出来的RGB模式是否一致                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//本次点屏过程：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
//0. 非常感谢张同学和梁同学在本次点屏中所作的关键性工作。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
//1. 在mx51_kernel的mxcfb_epson_vga.c的fb_videomode结构体中修改了时序参数，上电，LCD无任何反应                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
//2. 张同学在mx51_3stack_gpio.c中通过配置GPIO NANDF_CS6 打开了LCD背光灯，LCD产生白屏闪动现象，并在mxcfb_epson_vga.c的lcd_init()中加入了ilitek提供的初始化命令。                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
//3. 梁同学在mx51_3stack_gpio.c中通过配置MX51_PIN_DI1_D1_CS ，使其一直拉低，提供了LCD Driver芯片的片选使能，并测量出upper margin和lower margin时序有偏移，经过调整此2值，消除了IPU error。                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//4. 去掉3条冗余的LCD初始化命令，LCD点亮。                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
//5. 对于本次调屏，以上步骤都是必要的，也是充分的                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
//                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
//kernel 文件修改：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
//1.driver/video/mxc/mxcfb_epson_vga.c                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
(1).static struct fb_videomode video_modes[] 改为：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
1.static struct fb_videomode video_modes[] = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
2.        {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
3.                /* 320x480 @ 60 Hz */                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
4.                "Elite-HVGA", 60, 320, 480, 86566, 20, 40, 5, 1, 10, 2,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
5.                FB_SYNC_CLK_LAT_FALL,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
6.                FB_VMODE_NONINTERLACED,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
7.                0,},                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
8.};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
复制代码                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
(2).static void lcd_init(void)改为：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
1.static void lcd_init(void)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
2.{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
3.        u16 i;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
4.const u16 cmd[] = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
5.          0x11,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
6.          0xD0, param(0x07), param(0x41), param(0x0F),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
7.          0xD1, param(0x00), param(0x3E), param(0x1F),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
8.          0xD2, param(0x01), param(0x10),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
9.          0xC0, param(0x00), param(0x3B), param(0x00), param(0x02),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
10.                param(0x11),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
11.          0xC5, param(0x02),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
12.//          0xC6, param(0x1B),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
13.          0xC6, param(0x02),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
14.          0xC8, param(0x66), param(0x66), param(0x66), param(0x66),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
15.                param(0x0E), param(0x1E), param(0x66), param(0x66),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
16.                param(0x77), param(0x66), param(0x0F), param(0x0F),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
17.          0x36, param(0x0A),    // set_address_mode, RGB order                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
18.          0x3A, param(0x66),        // 0x60: RGB=666; 0x50: RGB=565; 0x10: RGB=111                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
19.          0xB4, param(0x11),                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
20.          0x29,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
21.          0x2C                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
22.};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
23.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
24.        if (lcd_spi) {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
25.                spi_write(lcd_spi, (const u8 *)cmd, ARRAY_SIZE(cmd));                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
26.        } else {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
27.                for (i = 0; i < sizeof(cmd) / 2; i++)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
28.                {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
29.                        ipu_disp_direct_write(DIRECT_ASYNC1, cmd[i], 0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
30.                }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
31.                msleep(1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
32.                ipu_uninit_channel(DIRECT_ASYNC1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
33.        }                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
34.}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
复制代码                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
2.arch/arm/mach-mx51/mx51_3stack.c                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
1.static struct mxc_lcd_platform_data lcd_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
2.        .core_reg = "VIOHI",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
3.        .io_reg = "SW4",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
4.        .reset = lcd_reset,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
5.};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
复制代码                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
改为                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
1.static struct mxc_lcd_platform_data lcd_data = {                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
2.        .core_reg = "VSD",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
3.        .io_reg = "SW4",                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
4.        .reset = lcd_reset,                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
5.};                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
复制代码                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
3.arch/arm/mach-mx51/mx51_3stack_gpio.c                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     
void gpio_lcd_active(void)修改为：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
1.void gpio_lcd_active(void)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
2.{                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
3.        mxc_request_iomux(MX51_PIN_NANDF_CS6, IOMUX_CONFIG_ALT3);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
4.        mxc_set_gpio_direction(MX51_PIN_NANDF_CS6, 0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
5.        mxc_set_gpio_dataout(MX51_PIN_NANDF_CS6, 1);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
6.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
7.        mxc_request_iomux(MX51_PIN_DI1_D1_CS, IOMUX_CONFIG_ALT4);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
8.        mxc_set_gpio_direction(MX51_PIN_DI1_D1_CS, 0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
9.        mxc_set_gpio_dataout(MX51_PIN_DI1_D1_CS, 0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
10.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
11.        mxc_request_iomux(MX51_PIN_DI_GP2, IOMUX_CONFIG_ALT0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
12.        mxc_request_iomux(MX51_PIN_DI_GP3, IOMUX_CONFIG_ALT0);                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            
13.}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            