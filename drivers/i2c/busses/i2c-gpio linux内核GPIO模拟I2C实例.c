//   linux gpio模拟i2c的使用 .                                                                                                                                                                                                                                                                                          
//   分类： Linux学习 2011-06-29 20:13 1093人阅读 评论(3) 收藏 举报                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   linux kernel 中的i2c-gpio使用                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   在linux中，我们可以自己来使用gpio来模拟i2c，但是万能的linux中其实也已经有了i2c的东东了。                                                                                                                                                                                                                           
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   <!--[endif]-->                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                   
//   现在看看i2c-gpio.c文件中到底提供了哪些接口                                                                                                                                                                                                                                                                         
//                                                                                                                                                                                                                                                                                                                   
//   [cpp] view plaincopyprint?                                                                                                                                                                                                                                                                                         
//   01.static void i2c_gpio_setsda_dir(void *data, int state)                                                                                                                                                                                                                                                          
//   02.static void i2c_gpio_setsda_val(void *data, int state)                                                                                                                                                                                                                                                          
//   03.static void i2c_gpio_setscl_dir(void *data, int state)                                                                                                                                                                                                                                                          
//   04.static void i2c_gpio_setscl_val(void *data, int state)                                                                                                                                                                                                                                                          
//   05.static int i2c_gpio_getsda(void *data)                                                                                                                                                                                                                                                                          
//   06.static int i2c_gpio_getscl(void *data)                                                                                                                                                                                                                                                                          
//   static void i2c_gpio_setsda_dir(void *data, int state)                                                                                                                                                                                                                                                             
//   static void i2c_gpio_setsda_val(void *data, int state)                                                                                                                                                                                                                                                             
//   static void i2c_gpio_setscl_dir(void *data, int state)                                                                                                                                                                                                                                                             
//   static void i2c_gpio_setscl_val(void *data, int state)                                                                                                                                                                                                                                                             
//   static int i2c_gpio_getsda(void *data)                                                                                                                                                                                                                                                                             
//   static int i2c_gpio_getscl(void *data)                                                                                                                                                                                                                                                                             
//                                                                                                                                                                                                                                                                                                                   
//   一看上面的接口，相当明确，跟普通的gpio模拟i2c所实现的接口一致，是实现的gpio的sda，scl的设置，仅此而已。                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                   
//   在kernel/driver/i2c/algos/i2c-algo-bit.c中是系统中默认提供的gpio模拟i2c的框架代码。                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   [cpp] view plaincopyprint?                                                                                                                                                                                                                                                                                         
//   01.static inline void sdalo(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                        
//   02.static inline void sdahi(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                        
//   03.static inline void scllo(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                        
//   04.static int sclhi(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                                
//   05.static void i2c_start(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                           
//   06.static void i2c_repstart(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                        
//   07.static void i2c_stop(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                            
//   08.static int i2c_outb(struct i2c_adapter *i2c_adap, unsigned char c)                                                                                                                                                                                                                                              
//   09.static int i2c_inb(struct i2c_adapter *i2c_adap)                                                                                                                                                                                                                                                                
//   10.static int test_bus(struct i2c_algo_bit_data *adap, char *name)                                                                                                                                                                                                                                                 
//   11.static int try_address(struct i2c_adapter *i2c_adap,                                                                                                                                                                                                                                                            
//   12.                          unsigned char addr, int retries)                                                                                                                                                                                                                                                      
//   13.static int sendbytes(struct i2c_adapter *i2c_adap, struct i2c_msg *msg)                                                                                                                                                                                                                                         
//   14.static int acknak(struct i2c_adapter *i2c_adap, int is_ack)                                                                                                                                                                                                                                                     
//   15.static int readbytes(struct i2c_adapter *i2c_adap, struct i2c_msg *msg)                                                                                                                                                                                                                                         
//   16.static int bit_doAddress(struct i2c_adapter *i2c_adap, struct i2c_msg *msg)                                                                                                                                                                                                                                     
//   17.static int bit_xfer(struct i2c_adapter *i2c_adap,                                                                                                                                                                                                                                                               
//   18.                       struct i2c_msg msgs[], int num)                                                                                                                                                                                                                                                          
//   19.// -----exported algorithm data: -------------------------------------                                                                                                                                                                                                                                        
//   20.                                                                                                                                                                                                                                                                                                                
//   21.static const struct i2c_algorithm i2c_bit_algo = {                                                                                                                                                                                                                                                              
//   22.         .master_xfer    = bit_xfer,                                                                                                                                                                                                                                                                            
//   23.         .functionality   = bit_func,                                                                                                                                                                                                                                                                           
//   24.};                                                                                                                                                                                                                                                                                                              
//   static inline void sdalo(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                           
//   static inline void sdahi(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                           
//   static inline void scllo(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                           
//   static int sclhi(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                                   
//   static void i2c_start(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                              
//   static void i2c_repstart(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                           
//   static void i2c_stop(struct i2c_algo_bit_data *adap)                                                                                                                                                                                                                                                               
//   static int i2c_outb(struct i2c_adapter *i2c_adap, unsigned char c)                                                                                                                                                                                                                                                 
//   static int i2c_inb(struct i2c_adapter *i2c_adap)                                                                                                                                                                                                                                                                   
//   static int test_bus(struct i2c_algo_bit_data *adap, char *name)                                                                                                                                                                                                                                                    
//   static int try_address(struct i2c_adapter *i2c_adap,                                                                                                                                                                                                                                                               
//                             unsigned char addr, int retries)                                                                                                                                                                                                                                                         
//   static int sendbytes(struct i2c_adapter *i2c_adap, struct i2c_msg *msg)                                                                                                                                                                                                                                            
//   static int acknak(struct i2c_adapter *i2c_adap, int is_ack)                                                                                                                                                                                                                                                        
//   static int readbytes(struct i2c_adapter *i2c_adap, struct i2c_msg *msg)                                                                                                                                                                                                                                            
//   static int bit_doAddress(struct i2c_adapter *i2c_adap, struct i2c_msg *msg)                                                                                                                                                                                                                                        
//   static int bit_xfer(struct i2c_adapter *i2c_adap,                                                                                                                                                                                                                                                                  
//                          struct i2c_msg msgs[], int num)                                                                                                                                                                                                                                                             
//   // -----exported algorithm data: -------------------------------------                                                                                                                                                                                                                                           
//                                                                                                                                                                                                                                                                                                                      
//   static const struct i2c_algorithm i2c_bit_algo = {                                                                                                                                                                                                                                                                 
//            .master_xfer    = bit_xfer,                                                                                                                                                                                                                                                                               
//            .functionality   = bit_func,                                                                                                                                                                                                                                                                              
//   };                                                                                                                                                                                                                                                                                                                 
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   这里对于任何一个做过gpio模拟i2c模拟的童鞋来说都没有陌生的东西，不明白的可以看看i2c的协议，比我说的清楚。                                                                                                                                                                                                           
//                                                                                                                                                                                                                                                                                                                   
//   这里说下出现的struct i2c_algorithm，其中的master_xfer就是我们调用i2c_master_send/i2c_master_recv的时候最终调用的接口。                                                                                                                                                                                             
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   下面说说如何使用此i2c-gpio的框架代码                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                   
//   <!--[if !supportLists]-->1、  <!--[endif]-->查看board.c文件，先看看系统中的i2c的注册是在哪里注册的，添加如下                                                                                                                                                                                                       
//                                                                                                                                                                                                                                                                                                                   
//   [c-sharp] view plaincopyprint?   

//===========================打开注释回车    /*================================  

                                                                                                                                                                                                                                                                                  
  static struct i2c_gpio_platform_data i2c_bus_data = {                                                                                                                                                                                                                                                           
   	.sda_pin = GPIO103,                                                                                                                                                                                                                                                                                            
   	.scl_pin = GPIO102,                                                                                                                                                                                                                                                                                            
   	.udelay  = 20,                                                                                                                                                                                                                                                                                                 
   	.timeout = 100,                                                                                                                                                                                                                                                                                                
   	.sda_is_open_drain = 1,                                                                                                                                                                                                                                                                                        
   	.scl_is_open_drain = 1,                                                                                                                                                                                                                                                                                        
  };                                                                                                                                                                                                                                                                                                              
   static struct platform_device arch_device_i2c[] = {                                                                                                                                                                                                                                                             
       {                                                                                                                                                                                                                                                                                                           
       .name              = "arch-i2c-1",                                                                                                                                                                                                                                                                          
           .id            = 0,                                                                                                                                                                                                                                                                                     
       .num_resources = ARRAY_SIZE(arch_resource),                                                                                                                                                                                                                                                                 
       .resource      = arch_resource,                                                                                                                                                                                                                                                                             
       },                                                                                                                                                                                                                                                                                                          
       {                                                                                                                                                                                                                                                                                                           
       .name              = "arch-i2c-2",                                                                                                                                                                                                                                                                          
           .id            = 1,                                                                                                                                                                                                                                                                                     
       .num_resources = ARRAY_SIZE(arch_resource),                                                                                                                                                                                                                                                                 
       .resource      = arch_resource,                                                                                                                                                                                                                                                                             
       },                                                                                                                                                                                                                                                                                                          
   //add                                                                                                                                                                                                                                                                                                           
   {                                                                                                                                                                                                                                                                                                               
       .name              = "i2c-gpio",                                                                                                                                                                                                                                                                            
           .id            = 2,                                                                                                                                                                                                                                                                                     
       .dev              =                                                                                                                                                                                                                                                                                         
                       {                                                                                                                                                                                                                                                                                           
                                .platform_data = &i2c_bus_data,                                                                                                                                                                                                                                                    
                       }                                                                                                                                                                                                                                                                                           
       },                                                                                                                                                                                                                                                                                                          
   //end add                                                                                                                                                                                                                                                                                                       
   };                                                                                                                                                                                                                                                                                                              
   static struct i2c_gpio_platform_data i2c_bus_data = {                                                                                                                                                                                                                                                              
    .sda_pin = GPIO103,                                                                                                                                                                                                                                                                                               
    .scl_pin = GPIO102,                                                                                                                                                                                                                                                                                               
    .udelay  = 20,                                                                                                                                                                                                                                                                                                    
    .timeout = 100,                                                                                                                                                                                                                                                                                                   
    .sda_is_open_drain = 1,                                                                                                                                                                                                                                                                                           
    .scl_is_open_drain = 1,                                                                                                                                                                                                                                                                                           
   };                                                                                                                                                                                                                                                                                                                 
   static struct platform_device arch_device_i2c[] = {                                                                                                                                                                                                                                                                
       {                                                                                                                                                                                                                                                                                                              
       .name              = "arch-i2c-1",                                                                                                                                                                                                                                                                             
           .id            = 0,                                                                                                                                                                                                                                                                                        
       .num_resources = ARRAY_SIZE(arch_resource),                                                                                                                                                                                                                                                                    
       .resource      = arch_resource,                                                                                                                                                                                                                                                                                
       },                                                                                                                                                                                                                                                                                                             
       {                                                                                                                                                                                                                                                                                                              
       .name              = "arch-i2c-2",                                                                                                                                                                                                                                                                             
           .id            = 1,                                                                                                                                                                                                                                                                                        
       .num_resources = ARRAY_SIZE(arch_resource),                                                                                                                                                                                                                                                                    
       .resource      = arch_resource,                                                                                                                                                                                                                                                                                
       },                                                                                                                                                                                                                                                                                                             
   //add                                                                                                                                                                                                                                                                                                              
   {                                                                                                                                                                                                                                                                                                                  
       .name              = "i2c-gpio",                                                                                                                                                                                                                                                                               
           .id            = 2,                                                                                                                                                                                                                                                                                        
       .dev              =                                                                                                                                                                                                                                                                                            
                       {                                                                                                                                                                                                                                                                                              
                                .platform_data = &i2c_bus_data,                                                                                                                                                                                                                                                       
                       }                                                                                                                                                                                                                                                                                              
       },                                                                                                                                                                                                                                                                                                             
   //end add                                                                                                                                                                                                                                                                                                          
   };                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                   
//   这里看到了系统中有了两个i2c了，这里platform_device注册的时候id则使用了2,device name则是和i2c gpio的driver中的name是一致的，即i2c-gpio.c中的name。                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   <!--[if !supportLists]-->2、  <!--[endif]-->在使用gpio模拟i2c的设备中，需要指定使用的i2c的id，这样才可以知道使用的哪一个。这样在初始化时会对所在i2c总线进行遍历并得到该设备的适配器等信息，这样就像使用普通的i2c那样来使用了。                                                                                     
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   -----------------------------------------------华丽的分割线----------------------------------------------------------------------------                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   直接用GPIO口模拟I2C时序和利用内核模块i2c-gpio虚拟i2c总线的区别：                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   1． 用GPIO口模拟I2C时序不需要在系统启动时注册I2C总线，只需要在I2C设备驱动中单独实现。用i2c-gpio模块虚拟i2c总线需要在系统启动时注册新的I2C总线，并将i2c设备挂载到新的i2c总线，涉及的范围较广。                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   2． 用GPIO口模拟I2C时序，代码操作较繁琐，且不方便挂载多个i2c设备。用i2c-gpio模块可以完全模拟i2c总线，可以挂载多个设备。                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   3． 在i2c读写操作时，用GPIO口模拟I2C时序需要每次根据读/写操作发送器件地址<<1+1/0，然后再发送寄存器地址。用i2c-gpio模块相当于直接在i2c总线上操作，在系统启动挂载i2c设备时已经告诉了i2c总线它的地址，在该设备自己的驱动中，只需要通过i2c_add_driver操作即可以得到其地址等诸多信息，读写操作只需要发送寄存器地址即可。
//                                                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                   
//   Ps：                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                   
//      I2c调试的时候，也要具体再读读代码看看和你的时序是否一致，切记。   
//      
//      
//======================================================================================================                                                                                                                                                                                                                                                    
//linux内核GPIO模拟I2C实例                                                                                                                                                                                                                          
//前言：                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                     
//在许多情况下，我们并没有足够的I2C总线，本文主在介绍如何利用Linux内核中的i2c-gpio模块，利用2条GPIO线模拟i2c总线，并挂载设备。                                                                                                                                                                                         
//                                                                                                                                                                                                                                                                                                                     
//思路：                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                     
//先通过对i2c-gpio所定义的结构体初始化(包括初始化i2c的2条线，频率，timeout等)并将i2c-gpio模块编译进内核，实现用GPIO_X,GPIO_Y 2条GPIO线注册新的i2c总线。此时这个模块对i2c设备是透明的，及挂在这2条GPIO线的i2c设备可以直接使用Linux内核通用的i2c设备注册，传输和注销等方法。                                             
//                                                                                                                                                                                                                                                                                                                     
//步骤：                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                     
//首先确认在注册i2c-gpio模块前，所要用到的2条GPIO口是没有被系统其它地方所调用的。                                                                                                                                                                                                                                      
//                                                                                                                                                                                                                                                                                                                     
//在每个系统平台启动时，都会打开一系列的设备，他们通常实现在arch/目录下相应的平台子目录 中的例如setup.c，devices.c文件中，在这里我们进行i2c总线的注册以及设备的挂载。i2c-gpio定义的结构在 include/linux/i2c-gpio.h中：                                                                                                 
//                                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                     
// * struct i2c_gpio_platform_data - Platform-dependent data for i2c-gpio                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                     
// * @sda_pin: GPIO pin ID to use for SDA                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                     
// * @scl_pin: GPIO pin ID to use for SCL                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                     
// * @udelay: signal toggle delay. SCL frequency is (500 / udelay) kHz                                                                                                                                                                                                                                                 
//                                                                                                                                                                                                                                                                                                                     
// * @timeout: clock stretching timeout in jiffies. If the slave keeps                                                                                                                                                                                                                                                 
//                                                                                                                                                                                                                                                                                                                     
// * SCL low for longer than this, the transfer will time out.                                                                                                                                                                                                                                                         
//                                                                                                                                                                                                                                                                                                                     
// * @sda_is_open_drain: SDA is configured as open drain, i.e. the pin                                                                                                                                                                                                                                                 
//                                                                                                                                                                                                                                                                                                                     
// * isn't actively driven high when setting the output value high.                                                                                                                                                                                                                                                    
//                                                                                                                                                                                                                                                                                                                     
// * gpio_get_value() must return the actual pin state even if the                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                     
// * pin is configured as an output.                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                     
// * @scl_is_open_drain: SCL is set up as open drain. Same requirements                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                     
// * as for sda_is_open_drain apply.                                                                                                                                                                                                                                                                                   
//                                                                                                                                                                                                                                                                                                                     
// * @scl_is_output_only: SCL output drivers cannot be turned off.                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
struct i2c_gpio_platform_data {                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
unsigned int sda_pin;                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
unsigned int scl_pin;                                                                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
int udelay;                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                     
int timeout;                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
unsigned int sda_is_open_drain:1;                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
unsigned int scl_is_open_drain:1;                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
unsigned int scl_is_output_only:1;                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
//其中sda_pin和scl_pin分别是i2c总线的数据线和时钟线，在i2c-gpio中会通过gpio_request函数对这2个口进行申请，udelay和timeout如果不设初值，i2c-gpio中会自动将其设为默认值。                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
if (pdata->udelay)                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
bit_data->udelay = pdata->udelay;                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
else if (pdata->scl_is_output_only)                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
bit_data->udelay = 50; // 10 kHz                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
else                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                     
bit_data->udelay = 5; // 100 kHz                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
if (pdata->timeout)                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
bit_data->timeout = pdata->timeout;                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
else                                                                                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                     
bit_data->timeout = HZ / 10; // 100 ms                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
//初始化这个结构体后再将其装入platform_device结构体，方便注册：                                                                                                                                                                                                                                                        
//                                                                                                                                                                                                                                                                                                                     
static struct platform_device i2c_device = {                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
.name = "device-name",                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
.id = your-id,                                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                     
.dev = {                                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                     
.platform_data = &i2c_data,       // i2c_gpio_platform_data                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                     
},                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
//注册i2c-gpio设备                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                     
//将i2c设备挂入我们注册的总线：                                                                                                                                                                                                                                                                                        
//                                                                                                                                                                                                                                                                                                                     
platform_device_register(&i2c_device);                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
static struct i2c_board_info i2c_device[] = {                                                                                                                                                                                                                                                                        
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
I2C_BOARD_INFO("name", i2c_device_addr),                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                     
}                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
i2c_register_board_info(your-id, i2c_device, ARRAY_SIZE(i2c_device));                                                                                                                                                                                                                                                
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
//此时我们就可以在i2c设备的驱动程序中通过遍历所在i2c总线，得到其所在的地址i2c_device_addr。                                                                                                                                                                                                                            
//                                                                                                                                                                                                                                                                                                                     
//在i2c驱动中，需要注册一个i2c_driver的结构体，例如：                                                                                                                                                                                                                                                                  
//                                                                                                                                                                                                                                                                                                                     
static const struct i2c_device_id lis35de_id[] = {                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
{ "lis35de", 0 },                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
{ }                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
static struct i2c_driver st_lis35de_driver = {                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                     
.probe = st_lis35de_probe,                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                     
.remove = st_lis35de_remove,                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
.suspend = st_lis35de_suspend,                                                                                                                                                                                                                                                                                       
                                                                                                                                                                                                                                                                                                                     
.resume = st_lis35de_resume,                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
.id_table  = lis35de_id,                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                     
.driver = {                                                                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                     
.name = "lis35de",                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
},                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
static int __init st_lis35de_init(void)                                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
printk(KERN_INFO "st_lis35de_init\n");                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
return i2c_add_driver(&st_lis35de_driver);                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                     
}                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
// 在init时用 i2c_add_driver(&st_lis35de_driver)，此时将会对所在i2c总线进行遍历并得到该设备的适配器等信息，主要目 的即是使驱动得到自己的i2c_client，在这个i2c_client中，已经有了该i2c设备的地址等信息，我们在驱动中定义一个新的 i2c_client全局变量，把得到的这个i2c_client传给这个全局变量，从而可以继续后面的i2c操作。 
//                                                                                                                                                                                                                                                                                                                      
// 此时我们就可以使用通用的i2c读写操作了。                                                                                                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                      
// 总结：                                                                                                                                                                                                                                                                                                               
//                                                                                                                                                                                                                                                                                                                      
// 直接用GPIO口模拟I2C时序和利用内核模块i2c-gpio虚拟i2c总线的区别：                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                      
// 1． 用GPIO口模拟I2C时序不需要在系统启动时注册I2C总线，只需要在I2C设备驱动中单独实现。用i2c-gpio模块虚拟i2c总线需要在系统启动时注册新的I2C总线，并将i2c设备挂载到新的i2c总线，涉及的范围较广。                                                                                                                        
//                                                                                                                                                                                                                                                                                                                      
// 2． 用GPIO口模拟I2C时序，代码操作较繁琐，且不方便挂载多个i2c设备。用i2c-gpio模块可以完全模拟i2c总线，可以挂载多个设备。                                                                                                                                                                                              
//                                                                                                                                                                                                                                                                                                                      
// 3． 在i2c读写操作时，用GPIO口模拟I2C时序需要每次根据读/写操作发送器件地址<<1+1/0，然后再发送寄存器地址。用i2c- gpio模块相当于直接在i2c总线上操作，在系统启动挂载i2c设备时已经告诉了i2c总线它的地址，在该设备自己的驱动中，只需要通过 i2c_add_driver操作即可以得到其地址等诸多信息，读写操作只需要发送寄存器地址即可。
//                                                                                                                                                                                                                                                                                                                      
// 附：i2c一般的读写操作                                                                                                                                                                                                                                                                                                
//                                                                                                                                                                                                                                                                                                                      
//#include <linux/i2c.h>                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
//读操作：                                                                                                                                                                                                                                                                                                             
//                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
static int i2c_RxData(char *rxData, int length)                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
struct i2c_msg msgs[] = {                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                     
         // 把1个字节的i2c设备寄存器地址告诉总线                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
 .addr = client->addr,                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
 .flags = 0,                     //写操作                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                     
 .len = 1,                                                                                                                                                                                                                                                                                                           
                                                                                                                                                                                                                                                                                                                     
 .buf = rxData,                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
 },                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
          // 从总线读取length个字节的数据，存入rxData                                                                                                                                                                                                                                                              
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
 .addr =client ->addr,                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
 .flags = I2C_M_RD,             //I2C_M_RD在i2c.h中被定义为1，读操作                                                                                                                                                                                                                                                 
                                                                                                                                                                                                                                                                                                                     
 .len = length,                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
 .buf = rxData,                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
 },                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
if (i2c_transfer(client->adapter, msgs, 2) < 0) {   // 传输并判断是否传输错误                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
printk(KERN_ERR "I2C_RxData: transfer error\n");                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
return -EIO;                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
} else                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
return 0;                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                     
}                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
//                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
//写操作                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
static int i2c_TxData(char *txData, int length)                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
struct i2c_msg msg[] = {                                                                                                                                                                                                                                                                                             
                                                                                                                                                                                                                                                                                                                     
     // 第1个字节是器件寄存器地址，后面的字节是写入的数据                                                                                                                                                                                                                                                          
                                                                                                                                                                                                                                                                                                                     
{                                                                                                                                                                                                                                                                                                                    
                                                                                                                                                                                                                                                                                                                     
 .addr = client->addr,                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
 .flags = 0,                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
 .len = length,                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
 .buf = txData,                                                                                                                                                                                                                                                                                                      
                                                                                                                                                                                                                                                                                                                     
 },                                                                                                                                                                                                                                                                                                                  
                                                                                                                                                                                                                                                                                                                     
};                                                                                                                                                                                                                                                                                                                   
                                                                                                                                                                                                                                                                                                                     
if (i2c_transfer(client->adapter, msg, 1) < 0) {                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
printk(KERN_ERR "I2C_TxData: transfer error\n");                                                                                                                                                                                                                                                                     
                                                                                                                                                                                                                                                                                                                     
return -EIO;                                                                                                                                                                                                                                                                                                         
                                                                                                                                                                                                                                                                                                                     
} else                                                                                                                                                                                                                                                                                                               
                                                                                                                                                                                                                                                                                                                     
return 0;                                                                                                                                                                                                                                                                                                            
                                                                                                                                                                                                                                                                                                                     
}                                                                                                                                                                                                                                                                                                                    